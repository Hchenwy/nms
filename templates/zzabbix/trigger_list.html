{% extends 'base.html' %}

{% block title %}
<title>Zalt NMS</title>
{% endblock %}

{% block content %}
<div class="page-content">
    <div class="row">
        <div class="col-md-12 col-sm-12 col-xs-12">
            <div class="tabbable">
                <div class="tab-content no-border padding-lr-24">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="dataTables_length pull-left">
                                <label><button id="addBtn" type="button" class="btn  btn-success " data-toggle="modal" onclick="add_trigger()"> 新增触发 </button></label>
                                <!--<label><button type="button" class="btn  btn-purple " data-toggle="modal" onclick="sync_zabbix()"> 同步数据 </button></label>-->
                                <label><button type="button" class="btn btn-danger" data-toggle="modal" onclick="del_all_trigger()"> 删除所选 </button></label>
                            </div>
                            <div class="dataTables_length pull-right">
                                <label>所属节点：
                                    <select id="father_node" onchange="sel_node()">
                                        {% for node in node_list %}
                                            {% if nodeid == node.id %}
                                            <option value="{{ node.id }}" selected="selected">{{ node.name }}</option>
                                            {% else %}
                                            <option value="{{ node.id }}">{{ node.name }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </label>
                                <label>主机/模板：
                                    <select id="hosttemplate" onchange="sel_host()" style="width:250px">
                                        <option value="0">所有</option>
                                        {% for host in host_list %}
                                            {% if hostid == host.hostid %}
                                            <option value="{{ host.hostid }},{{ host.host }}" selected="selected">{{ host.host }}</option>
                                            {% else %}
                                            <option value="{{ host.hostid }},{{ host.host }}">{{ host.host }}</option>
                                            {% endif%}
                                        {% endfor %}
                                    </select>
                                </label>
                                <label><input  id="keyword" type="text" class="w210 inputCheck1" placeholder="关键字搜索"></label>
                                <label><button type="button" class="btn btn-info " onclick="key_search()"> 查询 </button></label>
                            </div>
                        </div>
                        <div class="col-md-12 col-sm-12 col-xs-12 " >
                            <table class="table table-striped table-bordered table-hover" align="left">
                                <thead>
                                    <tr role="row">
                                        <th width="30"> <label><input type="checkbox" class="ace" id="select_all"><span class="lbl"></span></label></th>
                                        <th width="80">告警等级</th>
                                        <th>主机/模板</th>
                                        <th>触发器名</th>
                                        <th>表达式</th>
                                        <th>所属节点</th>
                                        <th width="80">状态</th>
                                        <th width="60">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="tbl_all"></tbody>
                            </table>
                            <div class="col-sm-8 padding-left-0" class="form-inline">
                                <label id="sel_icon"></label>
                                <label id="node_num"></label>
                            </div>
                            <div class="col-sm-4 padding-right-0">
                                <div class="dataTables_paginate paging_bootstrap">
                                    <ul class="pagination" id="page_navi"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 新增、编辑触发器 -->
<div id="addtrigger" class="modal fade in" tabindex="-1" aria-hidden="false" >
    <div class="modal-dialog" style="width: 1000px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="bootbox-close-button close" data-dismiss="modal">×</button>
                <h4 class="modal-title">编辑触发器</h4>
            </div>
            <div class="modal-body">
                    <div class="scroller" data-always-visible="1" data-rail-visible1="1">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="portlet-body form">
                                    <form class="form-horizontal" role="form" id="confirmTrigger">
                                        <input type="hidden" id="itemid-db" name="itemid-db">
                                        <input type="hidden" id="nodeid" name="nodeid">
                                        <input type="hidden" id="triggerid" name="triggerid" value="0">
                                        <div class="form-body">
                                            <div class="form-group" id="fatherTrigger" style="display:none">
                                                <label class="col-md-3 control-label">上层触发器:</label>
                                                <div class="col-md-6" id="triLink"></div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>触发器名</label>
                                                <div class="col-md-6">
                                                    <input type="text" required class="form-control" id="description" name="description" value=""
                                                        data-bv-notempty="true" data-bv-notempty-message="触发器名称不能为空！"
                                                        data-bv-stringlength="true" data-bv-stringlength-max="100" data-bv-stringlength-message="长度不能超过100"/>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>表达式</label>
                                                <div class="col-md-6">
                                                    <textarea rows="5" required cols="" class="form-control"  name="expression" id="expression"
                                                        data-bv-notempty="true" data-bv-notempty-message="告警表达式不能为空！"
                                                        data-bv-stringlength="true" data-bv-stringlength-max="500" data-bv-stringlength-message="长度不能超过500">
                                                    </textarea>
                                                </div>
                                                <button id="sel_exp" type="button" class="btn btn-success " data-toggle="modal" onclick="add_exp()"> 添加 </button>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>告警等级</label>
                                                <div class="col-md-4">
                                                    <select id="priority" name="priority" class="form-control" onfocus="this.defaultIndex=this.selectedIndex;">
                                                        <option value="1" >一般</option>
                                                        <option value="3" >严重</option>
                                                        <option value="5" >灾难</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>触发状态</label>
                                                <div class="col-md-9">
                                                    <label class="margin-right-10">
                                                        <input name="status" type="radio" class="ace" value="0"  data-bv-notempty="true" data-bv-notempty-message="请选择状态！" >
                                                        <span class="lbl">&nbsp;正常触发</span>
                                                    </label>
                                                    <label class="margin-right-10">
                                                        <input name="status" type="radio" class="ace" value="1"  data-bv-notempty="true" data-bv-notempty-message="请选择状态！" >
                                                        <span class="lbl">&nbsp;暂停触发</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label">告警描述</label>
                                                <div class="col-md-6">
                                                    <textarea id="comments" name="comments" rows="4" class="form-control"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirm_trigger()">保存</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<!-- 添加表达式 -->
<div id="addexp" class="modal fade in" tabindex="-1" aria-hidden="false" >
    <div class="modal-dialog" style="width: 1020px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="bootbox-close-button close" data-dismiss="modal">×</button>
                <h4 class="modal-title">添加表达式</h4>
            </div>
            <div class="modal-body">
                <div style="height:450px;">
                    <div class="scroller" data-always-visible="1" data-rail-visible1="1">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="portlet-body form">
                                    <form class="form-horizontal" role="form" id="expForm">
                                        <input type="hidden" id="itemid" name="itemid">
                                        <input type="hidden" id="itemkey" name="itemkey">
                                        <input type="hidden" id="triggerNowId" name="triggerNowId" value="0">
                                        <div class="form-body">
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>监控项</label>
                                                <div class="col-md-6"><input type="text" readonly="readonly" class="form-control" id="item-name-key" name="item-name-key" data-bv-notempty="true" data-bv-notempty-message="请选择监控项！"/></div>
                                                <button type="button" class="btn btn-success " onclick="add_item()"> 选择 </button>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>函数</label>
                                                <div class="col-md-6">
                                                    <select class="form-control" id="function" name="function">
                                                        <option value="last,&lt;,0" selected="selected">最新值小于N</option>
                                                        <option value="last,=,0">最新值等于N</option>
                                                        <option value="last,&gt;,0">最新值大于N</option>
                                                        <option value="last,&lt;&gt;,0">最新值不等于N</option>
                                                        <option value="avg,&lt;,1">周期（T）内的平均值小于N</option>
                                                        <option value="avg,=,1">周期（T）内的平均值等于N</option>
                                                        <option value="avg,&gt;,1">周期（T）内的平均值大于N</option>
                                                        <option value="avg,&lt;&gt;,1">周期（T）内的平均值不等于N</option>
                                                        <option value="diff,=,0">最新值和前一个值不相同时返回1，返回值等于N</option>
                                                        <option value="diff,&lt;&gt;,0">最新值和前一个值不相同时返回1，返回值不等于N</option>
                                                        <option value="change,&lt;,0">最新值和前一个值差值小于N</option>
                                                        <option value="change,=,0">最新值和前一个值差值等于N</option>
                                                        <option value="change,&gt;,0">最新值和前一个值差值大于N</option>
                                                        <option value="change,&lt;&gt;,0">最新值和前一个值差值不等于N</option>
                                                        <option value="abschange,&lt;0">最新值和前一个值差值的绝对值小于N</option>
                                                        <option value="abschange,=,0">最新值和前一个值差值的绝对值等于N</option>
                                                        <option value="abschange,&gt;0">最新值和前一个值差值的绝对值大于N</option>
                                                        <option value="abschange,&lt;&gt;,0">最新值和前一个值差值的绝对值不等于N</option>
                                                        <option value="strlen,&lt;,0">最新值字符长度小于N</option>
                                                        <option value="strlen,=,0">最新值字符长度等于N</option>
                                                        <option value="strlen,&gt;,0">最新值字符长度大于N</option>
                                                        <option value="strlen,&lt;&gt;,0">最新值字符长度不等于N</option>
                                                        <option value="max,&lt;,1">周期（T）内的最大值小于N</option>
                                                        <option value="max,=,1">周期（T）内的最大值等于N</option>
                                                        <option value="max,&gt;,1">周期（T）内的最大值大于N</option>
                                                        <option value="max,&lt;&gt;,1">周期（T）内的最大值不等于N</option>
                                                        <option value="min,&lt;,1">周期（T）内的最小值小于N</option>
                                                        <option value="min,=,1">周期（T）内的最小值等于N</option>
                                                        <option value="min,&gt;,1">周期（T）内的最小值大于N</option>
                                                        <option value="min,&lt;&gt;,1">周期（T）内的最小值不等于N</option>
                                                        <option value="nodata,=,1">周期（T）内未接收数据则返回1，返回值等于N</option>
                                                        <option value="nodata,&lt;&gt;,1">周期（T）内未接收数据则返回1，返回值不等于N</option>
                                                        <option value="fuzzytime,=,2">Client时间和Server时间相差超过T秒则返回0，返回值等于N</option>
                                                        <option value="fuzzytime,&lt;&gt;,2">Client时间和Server时间相差超过T秒则返回0，返回值不等于N</option>
                                                        <option value="sum,&lt;,1">周期（T）内的数值求和小于N</option>
                                                        <option value="sum,=,1">周期（T）内的数值求和等于N</option>
                                                        <option value="sum,&gt;,1">周期（T）内的数值求和大于N</option>
                                                        <option value="sum,&lt;&gt;,1">周期（T）内的数值求和不等于N</option>
                                                        <!--<option value="str[=]">最后值中是否包含字符串V，等于1表示包含，0表示其他</option>
							                            <option value="str[&lt;&gt;]">最后值中是否包含字符串V，不等于1表示包含，0表示其他</option>
                                                        <option value="date[&lt;]">当前日期小于 N</option>
                                                        <option value="date[=]">当前日期等于N</option>
                                                        <option value="date[&gt;]">当前日期大于N</option>
                                                        <option value="date[&lt;&gt;]">当前日期不等于N</option>
                                                        <option value="time[&lt;]">当前时间小于N</option>
                                                        <option value="time[=]">当前时间等于N</option>
                                                        <option value="time[&gt;]">当前时间大于N</option>
                                                        <option value="time[&lt;&gt;]">当前时间不等于N</option>
                                                        <option value="dayofmonth[&lt;]">当前时间在月份中的天数小于N</option>
                                                        <option value="dayofmonth[=]">当前时间在月份中的天数等于N</option>
                                                        <option value="dayofmonth[&gt;]">当前时间在月份中的天数大于N</option>
                                                        <option value="dayofmonth[&lt;&gt;]">当前时间在月份中的天数不等于N</option>
                                                        <option value="dayofweek[&lt;]">当前时间在星期中的天数小于N</option>
                                                        <option value="dayofweek[=]">当前时间在星期中的天数等于N</option>
                                                        <option value="dayofweek[&gt;]">当前时间在星期中的天数大于N</option>
                                                        <option value="dayofweek[&lt;&gt;]">当前时间在星期中的天数不等于N</option>
                                                        <option value="delta[&lt;]">周期（T）内最大值与最小值的差小于N</option>
                                                        <option value="delta[=]">周期（T）内最大值与最小值的差等于N</option>
                                                        <option value="delta[&gt;]">周期（T）内最大值与最小值的差大于N</option>
                                                        <option value="delta[&lt;&gt;]">周期（T）内最大值与最小值的差不等于N</option>
                                                        <option value="forecast[&lt;]">根据周T内的值小于N预测下一个t秒的值</option>
                                                        <option value="forecast[=]">根据周期T内的值等于N预测下一个t秒的值</option>
                                                        <option value="forecast[&gt;]">根据周期T内的值大于N预测下一个t秒的值</option>
                                                        <option value="forecast[&lt;&gt;]">根据周期T内的值不等于N预测下一个t秒的值</option>
                                                        <option value="now[&lt;]">时间戳小于N</option>
                                                        <option value="now[=]">时间戳等于N</option>
                                                        <option value="now[&gt;]">时间戳大于N</option>
                                                        <option value="now[&lt;&gt;]">时间戳不等于N</option>
                                                        <option value="prev[&lt;]">前一个值小于N</option>
                                                        <option value="prev[=]">前一个值等于N</option>
                                                        <option value="prev[&gt;]">前一个值大于N</option>
                                                        <option value="prev[&lt;&gt;]">前一个值不等于N</option>-->
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group" id="period_div" style="display: none">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>周期（T）</label>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control" id="period" name="period"
                                                           data-bv-regexp="true" data-bv-regexp-regexp="^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$" data-bv-regexp-message="只能输入数字"/>
                                                </div>
                                                <select id="paramtype">
                                                    <option value="">时间</option>
                                                    <option value="#">次数</option>
                                                 </select>
                                            </div>
                                            <div class="form-group" id="time_div" style="display: none">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>时间（T）</label>
                                                <div class="col-md-3">
                                                    <input type="text" class="form-control" id="time" name="time"
                                                           data-bv-regexp="true" data-bv-regexp-regexp="^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$" data-bv-regexp-message="只能输入数字"/>
                                                </div>
                                                <span style="text-align:center;line-height:30px;">秒</span>
                                            </div>
                                            <!--<div class="form-group" style="display: none">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>掩码</label>
                                                <div class="col-md-3"><input type="text" class="form-control" id="mask" name="mask" data-bv-notempty="true" data-bv-notempty-message="掩码不能为空"/></div>
                                            </div>
                                            <div class="form-group">
                                                <label class="col-md-3 control-label">时间偏移量</label>
                                                <div class="col-md-3"><input type="text" class="form-control" id="timeShift" name="timeShift" data-bv-regexp="true" data-bv-regexp-regexp="^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$" data-bv-regexp-message="只能输入数字"/></div>
                                                <span>时间</span>
                                            </div>-->
                                            <div class="form-group">
                                                <label class="col-md-3 control-label"><strong class="hint">*</strong>N</label>
                                                <div class="col-md-3">
                                                    <input type="number" class="form-control" id="N-value" name="N-value" value="0" data-bv-notempty="true" data-bv-notempty-message="请输入值"
                                                        data-bv-regexp="true" data-bv-regexp-regexp="^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$" data-bv-regexp-message="只能输入数字"/>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirm_exp()">保存</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
<!-- 选择监控项 -->
<div id="additem" class="modal fade in" tabindex="-1" aria-hidden="false">
    <div class="modal-dialog" style="width: 1040px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="bootbox-close-button close" data-dismiss="modal">×</button>
                <h4 class="modal-title">选择监控项</h4>
            </div>
            <div class="modal-body">
                <div style="height:500px; overflow:auto;">
                    <div class="scroller" data-always-visible="1" data-rail-visible1="1">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="dataTables_length pull-right">
                                    <label>所属节点：<input size="30" type="text"  readonly="readonly" name="nodename" id="nodename" value=""/></label>
                                    <label>主机/模板：<input size="30" type="text"  readonly="readonly" name="hostname" id="hostname" value=""/></label>
                                </div>
                            </div>
                            <div class="col-sm-12 ">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr role="row">
                                            <th>监控名称</th>
                                            <th>监控键值</th>
                                            <th width="50">选择</th>
                                        </tr>
                                    </thead>
                                    <tbody id="item_tbl">
                                        <tr>
	                                        <td>impala.chk[20000047,idc_active_resources_ip]</td>
	                                        <td>idc_active_resources_ip(20000047)</td>
	                                        <td></td>
	                                        <td class="text-center"><label><input name="itemKey" type="radio" class="ace" value="197" data-key="impala.chk[20000047,idc_active_resources_ip]" data-name="idc_active_resources_ip(20000047)"/>
                                                <span class="lbl">&nbsp;</span>
							                </label></td>
	                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirm_item()">确定</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block custom_foot_js %}
<script src="/static/js/jquery.shiftcheckbox.js"></script>
<script src="/static/js/bootstrapValidator/js/bootstrapValidator.js"></script>
<script src="/static/js/zabbix/page_control.js"></script>
<script >
/**** 新增、编辑触发器 ****/
/* 第一层模态框 */
//新增触发器、第一层模态框
function add_trigger() {
    $("#confirmTrigger")[0].reset();
    $("#triggerid").val('0');
    $("#confirmTrigger").data("bootstrapValidator").resetForm();
    $('#fatherTrigger').attr("style", "display:none");
    $('#confirmTrigger').find('input,textarea').attr('readonly', false);
    $('#priority').attr('onchange', '');
    $('#addtrigger').modal('show');
    $('#sel_exp').attr('disabled', false);
}
//json转trigger
function json_to_tri(data) {
    var father_node = $('#father_node').val();

    if (data.father_tri_id != undefined) {
        $('#fatherTrigger').attr("style", "display:block");
        $('#confirmTrigger').find('input,textarea').attr('readonly', true);
        $('#priority').attr('onchange', 'this.selectedIndex=this.defaultIndex;');
        $('#triLink').empty();
        $('#triLink').append('<a href="/nodes/trigger_list/?nodeid=' + father_node + '&hostid=' + data.father_id + '&triggerid=' + data.father_tri_id  + '">' + data.father_name + '</a>');
    }
    if (data.comments != undefined) $('#comments').val(data.comments);
    if (data.description != undefined) $('#description').val(data.description);
    if (data.expression != undefined) $('#expression').val(data.expression);
    if (data.priority != undefined) {
        $('#priority option[value="'+ data.priority +'"]').attr("selected", true);
    }
    if (data.status != undefined) {
        $(":radio[name='status'][value='" + data.status + "']").attr("checked", "checked");
    }
    if(data.item_id != undefined) $('#itemid-db').val(data.item_id);
    $('#nodeid').val($('#father_node').val());
}
//编辑触发器
function trigger_edit(trigger_id) {
    add_trigger();
    $('#sel_exp').attr('disabled', true);
    $('#triggerNowId').val(trigger_id); //备份当前触发器id

    $.post('/nodes/trigger_edit/', {
        "node_id": $('#father_node').val(),
        "trigger_id": trigger_id,
    }, function(data){
        json_to_tri(data);
        $('#triggerid').val(trigger_id);
    }, "json");
}
//提交第一层模态框数据
$('#confirmTrigger').bootstrapValidator();
function confirm_trigger() {
    form_list = $('#confirmTrigger').serialize();

    $('#confirmTrigger').bootstrapValidator('validate');
    if(!$("#confirmTrigger").data('bootstrapValidator').isValid()) return false;

    $.get('/nodes/trigger_add/?' + form_list, {}, function(data){
        alert(data);
        $('#addtrigger').modal('hide');
        window.location.reload();
    });
}

/* 第二层模态框 */
//添加表达式、第二层模态框
function add_exp() {
    $("#expForm")[0].reset();
    $("#expForm").data("bootstrapValidator").resetForm();
    $('#addexp').modal('show');
}

//提交第二层模态框内容
$('#expForm').bootstrapValidator();
function confirm_exp() {
    var host_id = $('#hosttemplate').val();
    var host_id_list = host_id.split(',');
    var item_id = $('#itemid').val();
    var item_key = $('#itemkey').val();
    var functions = $('#function').val();
    var period = $('#period').val();
    var param_type = $('#paramtype').val();
    var time = $('#time').val();
    var N_value = $('#N-value').val();
    var function_list = functions.split(',');
    var node_id = $("#father_node").val();
    var parameter = "";

    $('#expForm').bootstrapValidator('validate');
    if(!$("#expForm").data('bootstrapValidator').isValid()) return false;

    if (host_id_list.length < 2) return false;
    if (function_list.length != 3)  return false;
    if (function_list[2] == '0'){
        $('#expression').val('{' + host_id_list[1] + ':' + item_key + '.' + function_list[0] + '()}' + function_list[1] + N_value);
    } else if (function_list[2] == '1') {
        $('#expression').val('{' + host_id_list[1] + ':' + item_key + '.' + function_list[0] + '(' + param_type + period + ')}' + function_list[1] + N_value);
        parameter = param_type + period;
    } else if (function_list[2] == '2') {
        $('#expression').val('{' + host_id_list[1] + ':' + item_key + '.' + function_list[0] + '(' + time + ')}' + function_list[1] + N_value);
        parameter = time;
    }

    $('#itemid-db').val(item_id);
    $('#nodeid').val(node_id);
    $('#function-db').val(function_list[0]);
    $('#parameter').val(parameter);
    $('#addexp').modal('hide');
}
//选择函数事件
$('#function').change(function(){
    var val_str = $(this).val();
    var val_srr = [];

    if (val_str != undefined) {
        val_arr = val_str.split(',');
        /* */
        if (val_arr[2] == '0') {
            $("#period_div").css("display","none");
            $("#time_div").css("display","none");
        } else if (val_arr[2] == '1') {
            $("#period_div").css("display","block");
            $("#time_div").css("display","none");
        } else if (val_arr[2] == '2') {
            $("#period_div").css("display","none");
            $("#time_div").css("display","block");
        }
    }
})

/* 第三层模态框 */
//显示监控项表格
function json_to_item(list) {
    $('#item_tbl').empty();
    if (list == undefined) return;
    for (var i=0; i<list.length; i++) {
        var item_str = ""

        item_str += '<tr><td>' + list[i].name + '</td>';
        item_str += '<td>' + list[i].key_ + '</td>';
        item_str += '<td class="text-center"><label><input data-key="' + list[i].key_ + '" data-name="' + list[i].name + '" name="sel_item" type="radio" class="ace" value="' + list[i].id + '"/><span class="lbl">&nbsp;</span></label></td></tr>';

        $('#item_tbl').append(item_str);
    }
}
//选择监控项
function add_item() {
    var nodeid = $('#father_node').val();
    var hostid = $('#hosttemplate').val();
    var hostid_list = hostid.split(',');
    if (hostid_list.length < 1) return false;

    $('#additem').modal('show');
    $.post("{% url 'tri_add_item' %}", {
        "trigger_id": $('#triggerNowId').val(),
        "node_id": nodeid,
        "host_id": hostid_list[0],
    }, function(data){
        console.log(data);
        json_to_item(data.item_list);
        if (data.host_name != undefined) $("#hostname").val(data.host_name);
        if (data.node_name != undefined) $("#nodename").val(data.node_name);

    }, "json");
}
//提交第三层模态框内容
function confirm_item() {
    var item_id = $('input[name="sel_item"]:checked').val();
    var item_key = $('input[name="sel_item"]:checked').attr('data-key');
    var item_name = $('input[name="sel_item"]:checked').attr('data-name');

    if (item_id == undefined) item_id = "";
    if (item_key == undefined) item_key = "";
    if (item_name == undefined) item_name = "";
    if (item_key != "" || item_name != "") {
        var item_str = item_name + ':' + item_key;
    } else {
        var item_str = "";
    }

    $("#itemid").val(item_id);
    $("#itemkey").val(item_key);
    $("#item-name-key").val(item_str);
    $('#additem').modal('hide');
}

/* 删除触发器 */
//删除单个触发器
function del_trigger(trigger_id) {
    if (confirm("确定删除")) {
        $.post("{% url 'trigger_del' %}", {
            "node_id": $('#father_node').val(),
            "trigger_id": trigger_id,
        }, function(data){
            alert(data);
            window.location.reload();
        })
    }
}
//全选删除
$('#select_all').click(function(){
    var state = $(this).prop("checked");
    $("input[type='checkbox']").prop("checked", state);
})
//删除所有节点
function del_all_trigger() {
    var check_array = [];
    $("input:checkbox[name='selected']:checked").each(function() {
        check_array.push(jQuery(this).attr("value"))
    });

    if (check_array.length > 0) {
        del_trigger(check_array.join(','));
    }
}
//json转table显示
function json_to_tbl(obj) {
    $('#tbl_all').empty();
    if (typeof(obj) == "undefined") {
        return;
    }
    for (var i=0; i<obj.length; i++) {
        var html_str = ""

        html_str += '<tr><td class="text-center"><label><input type="checkbox" class="ace" name="selected" value="' + obj[i].trigger_id + '"><span class="lbl"></span> </label></td>';
        if (obj[i].priority > 3) html_str += '<td><span class="label label-sm label-danger">灾难</span></td>';
        else if (obj[i].priority == 3) html_str += '<td><span class="label label-sm label-warning">严重</span></td>';
        else html_str += '<td><span class="label label-sm label-info">一般</span></td>';

        html_str += '<td>' + obj[i].host + '</td>';
        if (obj[i].father_host) {
            html_str += '<td><a>' + obj[i].father_host + '</a>:' + obj[i].description + '</td>';
        } else {
            html_str += '<td>' + obj[i].description + '</td>';
        }

        html_str += '<td>' + obj[i].expression + '</td>';
        html_str += '<td>' + obj[i].father_node + '</td>';
        if (obj[i].status == 0) html_str += '<td><span class="label label-sm label-success">正常触发</span></td>';
        else if (obj[i].status == 1) html_str += '<td><span class="label label-sm label-default">暂停触发</span></td>';
        else html_str += '<td><span class="label label-sm label-danger">未知状态</span></td>';
        html_str += '<td><div class="visible-md visible-lg hidden-sm hidden-xs action-buttons"><a class="green" title="编辑" data-toggle="modal" onclick="trigger_edit(' + obj[i].trigger_id
            + ')"><i class="icon-pencil bigger-130"></i></a><a class="red" title="删除" data-toggle="modal"  onclick="del_trigger(' + obj[i].trigger_id + ')"><i class="icon-trash bigger-130"></i></a></div></td></tr>';

        $('#tbl_all').append(html_str);
    }
}
//json转option显示
function json_to_option(host_list) {
    var host_str = "";

    $('#hosttemplate').empty();

    host_str += '<option value="0"> 所有</option>';
    for(var i=0; i<host_list.length; i++) {
        host_str += '<option value="' + host_list[i].host_id + ',' + host_list[i].name + '">' + host_list[i].name + '</option>';
    }
    $('#hosttemplate').append(host_str);
}
//ajax 请求表单数据
function get_node_json(page_id) {
    var keyword = encodeURI($('#keyword').val());
    var father_node = $('#father_node').val();
    var page_size = $('#sel_size').val();
    var host_id = $('#hosttemplate').val();
    var hostid_list = host_id.split(',');

    if (hostid_list.length < 1) return false;
    if (page_size == undefined) page_size=10;
    $.ajax({
        type: "post",
        dataType: "json",
        url: "/nodes/trigger_list_json/",
        async:false,
        data:{"page_size": page_size,"page_id": page_id, "keyword": keyword, "father_node": father_node, "host_id": hostid_list[0]},
    }).done(function(json){
        console.log(json);
        json_to_tbl(json.trigger_list);
        show_page_navi(page_id, json.page_num);
        show_node_num(json.trigger_num);
    });
}
//翻页
function change_page(page_id) {
    get_node_json(page_id);
}
//关键字搜索
function key_search() {
    get_node_json(1);
}
//节点选择
function sel_node() {
    var father_node = $('#father_node').val();
    location.href = "{% url 'trigger_list' %}?nodeid=" + father_node + "&hostid=0";
}
//主机、模板选择
function sel_host() {
    var father_node = $('#father_node').val();
    var host_id = $('#hosttemplate').val();
    id_list = host_id.split(',');

    location.href = "{% url 'trigger_list' %}?nodeid=" + father_node + "&hostid=" + id_list[0];
}
//同步zabbix数据
function sync_zabbix() {
    if (confirm("确定同步全量数据？")) {
        $.post("{% url 'trigger_sync_zabbix' %}", {
            "node_id": $('#father_node').val(),
        }, function(data){
            alert(data);
            window.location.reload();
        });
    }
}
//mian函数
$(function(){
    var host_id = $('#hosttemplate').val();
    var father_tri_id = {{ father_tri_id }};

    if (host_id == 0) $('#addBtn').attr('disabled', true);
    get_node_json(1);
    show_sel_icon();
    if (father_tri_id) trigger_edit(father_tri_id);
    $("#sel_size").bind("change",function(){    //监听分页选择
        if($(this).val()==0){
          return;
        }
        else{
            get_node_json(1);
        }
    });
})
</script>
{% endblock %}